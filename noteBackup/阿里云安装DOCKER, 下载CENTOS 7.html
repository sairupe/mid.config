<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600646 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="2973"/>
<h1>阿里云安装DOCKER, 下载CENTOS 7.6</h1>
<div>
<table bgcolor="#D4DDE5" border="0">
<tr><td><b>创建时间：</b></td><td><i>2020/11/03 16:40</i></td></tr>
<tr><td><b>作者：</b></td><td><i>260789672@qq.com</i></td></tr>
<tr><td><b>来源：</b></td><td><a href="https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jdk"><i>https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jdk</i></a></td></tr>
</table>
</div>
<br/>

<div>
<span><div><div><div><div>腾讯云公网地址：http://106.52.53.192</div><hr/><div><br/></div><div>RPM安装JDK8</div><hr/><div><br/></div><div>安装MAVEN, 解压 apache-maven-3.6.3-bin.zip 到 /usr/local/apache-maven-3.6.3</div><div>默认仓库的地址是 /root/.m2/repository</div><div><br/></div><div>通过查找maven安装路径maven/conf/settings.xml的参数可以知道，它的默认下载路径是：Default: ${user.home}/.m2/repository ，很多人会问${user.home}是指哪里, 通过确认，即为：/root/.m2/repository。</div><div><br/></div><hr/><div>云主机安装DOCKER-CE</div><div><br/></div><div>yum makecache fast</div><div>yum install -y yum-utils</div><div>yum-config-manager --add-repo <a href="https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo">https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</a></div><div>yum list docker-ce --showduplicates|sort -r</div><div><br/></div><div><br/></div><div>yum install docker-ce-19.03.6-3.el7</div><div><br/></div><div>service docker start</div><div>systemctl enable docker</div><div><br/></div><hr/><div><br/></div><div>CENTOS镜像，200M</div><div><br/></div><div>增加 ect/docker/daemon.json 文件，内容如下</div><div>{</div><div>  &quot;registry-mirrors&quot;: [&quot;<a href="https://wixr7yss.mirror.aliyuncs.com/">https://wixr7yss.mirror.aliyuncs.com</a>&quot;]</div><div>}</div><div>docker pull centos:7.6.1810</div><div><br/></div><div><br/></div><div>alpine基础镜像，5.57M</div><div>docker pull alpine:3.12.0</div><div><span style="color: rgb(255, 70, 53);">docker pull alpine:3.11 （这个版本去打fabric8/java-alpine-openjdk8-jre:1.8 不报错能装上1.8）</span></div><div><br/></div><div><br/></div><div>fabric8/java-alpine-openjdk8-jre:1.8    87.9MB</div><div>fabric8/java-alpine-openjdk8-jdk:1.8   108MB</div><div><br/></div><hr/><div><span style="color: rgb(255, 0, 0);">基于 alpine 3.11.0构建</span>，</div><div>镜像文件地址： <a href="https://github.com/sairupe/mid.config/tree/master/dockerfile">https://github.com/sairupe/mid.config/tree/master/dockerfile</a>/<a href="https://github.com/sairupe/mid.config/blob/master/dockerfile/OsDockerfile" style="box-sizing: border-box; background-color: rgb(246, 248, 250); outline-width: 0px; font-size: 14px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: nowrap; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(3, 102, 214); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Helvetica, Arial, sans-serif, &quot;Apple Color Emoji&quot;, &quot;Segoe UI Emoji&quot;; font-variant-caps: normal; font-variant-ligatures: normal; text-decoration: underline;" title="OsDockerfile">OsDockerfile</a></div><div>参考文件地址： </div><div><a href="https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jre/dockerfile">https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jre/dockerfile</a></div><div><a href="https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jdk/dockerfile">https://hub.docker.com/r/fabric8/java-alpine-openjdk8-jdk/dockerfile</a></div><div><br/></div><div><br/></div><div><span style="color: rgb(255, 70, 53);">FROM alpine:3.11.0</span></div><div><br/></div><div>RUN echo -e <a href="https://mirrors.aliyun.com/alpine/v3.12/main/">https://mirrors.aliyun.com/alpine/v3.11/main/</a> &gt; /etc/apk/repositories</div><div><br/></div><div>RUN echo -e <a href="https://mirrors.aliyun.com/alpine/v3.12/community/">https://mirrors.aliyun.com/alpine/v3.11/community/</a> &gt;&gt; /etc/apk/repositories</div><div><br/></div><div>USER root</div><div><br/></div><div>RUN mkdir -p /app</div><div><br/></div><div># JAVA_APP_DIR is used by run-java.sh for finding the binaries</div><div>ENV JAVA_APP_DIR=/app \</div><div>    JAVA_MAJOR_VERSION=8</div><div><br/></div><div><br/></div><div># /dev/urandom is used as random source, which is perfectly safe</div><div># according to <a href="http://www.2uo.de/myths-about-urandom/">http://www.2uo.de/myths-about-urandom/</a></div><div>RUN apk add --update \</div><div>    curl \</div><div>    openjdk8=8.242.08-r0 \</div><div>&amp;&amp; rm /var/cache/apk/* \</div><div>&amp;&amp; echo &quot;securerandom.source=file:/dev/urandom&quot; &gt;&gt; /usr/lib/jvm/default-jvm/jre/lib/security/java.security</div><div><br/></div><div><span style="color: rgb(255, 70, 53);">// 解决APK源慢的问题， 替换镜像资源URL</span></div><div>RUN sed -i 's/<a href="http://dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g">dl-cdn.alpinelinux.org/mirrors.ustc.edu.cn/g</a>' /etc/apk/repositories &amp;&amp; \</div><div>  apk update &amp;&amp; \</div><div>  apk add openjdk8 busybox tzdata curl &amp;&amp; \</div><div> </div></div><hr/><div><br/></div><div>推送仓库 docker.hub </div><div>docker tag syrianazh/base_alpine_jdk8:0.0.1</div><div>docker push syrianazh/base_alpine_jdk8:0.0.1</div><div><br/></div><hr/><div><br/></div><div>JENKINS持续集成</div><div><br/></div><div>docker pull jenkins/jenkins:2.245-alpine</div><div><br/></div><div><br/></div><div>docker run -d -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home jenkins/jenkins:2.245-alpine</div><div>docker run -d -p 8080:8080 -p 50000:50000 -v /usr/local/jenkins_home:/var/jenkins_home jenkins/jenkins:2.245-alpine (不行，以后标准还是放这个目录)</div><div><br/></div><div>docker run -d -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home -v /var/run/docker.sock:/var/run/docker.sock jenkins/jenkins:2.245-alpine</div><div><br/></div><div><span style="text-decoration: line-through;">docker run -d -p 8080:8080 -p 50000:50000 -v /var/jenkins_home:/var/jenkins_home jenkins/jenkins:2.235.2-centos7</span></div><div><br/></div><div>jenkins/jenkins:2.245-alpine 的JDK版本</div><div>openjdk version &quot;1.8.0_212&quot;</div><div>OpenJDK Runtime Environment (IcedTea 3.12.0) (Alpine 8.212.04-r0)</div><div>OpenJDK 64-Bit Server VM (build 25.212-b04, mixed mode)</div><div><br/></div><div>启动坑及插件源加速</div><div>1.启动后长时间没反应，但后台已经打印出登录密码（secrets/initialAdminPassword文件中）。这时记下来，并把jenkins目录下的config.xml中的</div><div>crumbIssuer class=&quot;hudson.security.csrf.DefaultCrumbIssuer下的excludeClientIPFromCrumb的false改成true （解决CRUMB跨域报错403问题）</div><div>2.重启后输入刚才记的密码，</div><div>3.修改国内源地址，hudson.model.UpdateCenter.xml中改为<a href="https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</a>，这个只是下JSON，还要执行4</div><div>4.进入jenkins_home/updates,</div><div>  执行 sed -i 's#http://updates.jenkins-ci.org/download#https://mirrors.tuna.tsinghua.edu.cn/jenkins#g' default.json &amp;&amp; sed -i 's#http://www.google.com#https://www.baidu.com#g' default.json</div><div><br/></div><div><br/></div><div>// 1. 指定环境变量， 基于JenkinsDockerDockerfile文件构建</div><div>docker run -d -p 8080:8080 -p 50000:50000 \</div><div>-v /var/jenkins_home:/var/jenkins_home \</div><div>-v /usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3 \</div><div>-e &quot;M2_HOME=/usr/local/apache-maven-3.6.3&quot; \ </div><div>jenkins/jenkins:2.245-alpine</div><div><br/></div><div>// 2. 把宿主机的DOCKER SOCKET挂载进去， 基于JenkinsWithDockerFile文件构建  这样可以执行DOCKER命令了，但是体积较大</div><div>docker run -d -p 8080:8080 -p 50000:50000 \</div><div>--group-add docker \</div><div>-v /var/jenkins_home:/var/jenkins_home \</div><div>-v /usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3 \</div><div>-v /var/run/docker.sock:/var/run/docker.sock \</div><div><span style="color: rgb(255, 70, 53); text-decoration: line-through;">-v $(which docker):$(which docker) \ （不要这串为什么就可以在里面DOCKER INFO执行了？？？？）</span></div><div>--privileged=true \</div><div>jenkins:docker</div><div><img src="阿里云安装DOCKER, 下载CENTOS 7_files/Image.png" type="image/png" data-filename="Image.png"/></div><div><br/></div><div><span style="color: rgb(255, 0, 0);">// 下面这个脚本解决 jenkins/jenkins:2.235.2-lts-alpine 和 jenkinsci/blueocean:1.23.2 内部DOCKER命令问题！</span></div><div>docker run -d -p 8080:8080 -p 50000:50000 \</div><div><span style="color: rgb(255, 0, 0);">-u root \</span></div><div>-v /var/jenkins_home:/var/jenkins_home \</div><div>-v /usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3 \</div><div><span style="color: rgb(255, 0, 0);">-v /var/run/docker.sock:/var/run/docker.sock \</span></div><div>--privileged=true \</div><div>jenkins:docker</div><div><br/></div><div>// 正常脚本</div><div>docker run -d -p 8080:8080 -p 50000:50000 \</div><div><span style="color: rgb(255, 0, 0);">-u root \</span></div><div>-v /var/jenkins_home:/var/jenkins_home \</div><div>-v /usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3 \</div><div><span style="color: rgb(255, 0, 0);">-v /var/run/docker.sock:/var/run/docker.sock \</span></div><div>--privileged=true \</div><div>syrianazh/jenkins_docker:0.0.1</div><div><br/></div><div><span style="color: rgb(255, 70, 53);">//  挂载MAVEN仓库，避免每次都下载仓库</span></div><div>docker run -d -p 8080:8080 -p 50000:50000 \</div><div><span style="color: rgb(255, 0, 0);">-u root \</span></div><div>-v /var/jenkins_home:/var/jenkins_home \</div><div>-v /usr/local/apache-maven-3.6.3:/usr/local/apache-maven-3.6.3 \</div><div><span style="color: rgb(255, 0, 0);">-v /var/run/docker.sock:/var/run/docker.sock \</span></div><div><span style="color: rgb(255, 0, 0);">-v</span> <span style="color: rgb(255, 0, 0);">/root/.m2/repository</span><span style="color: rgb(255, 0, 0);">:</span><span style="color: rgb(255, 0, 0);">/root/.m2/repository</span> <span style="color: rgb(255, 0, 0);">\</span></div><div>--privileged=true \</div><div>--name jenkins-0.0.1 \</div><div>syrianazh/jenkins_docker:0.0.1</div><div><br/></div><div><br/></div><div>// 3.基于下面的构建</div><div>FROM jenkins/jenkins:2.245-alpine</div><div>ENV M2_HOME=/usr/local/apache-maven-3.6.3</div><div>ENV PATH=${PATH}:${M2_HOME}/bin</div><div><br/></div><div>user root</div><div>RUN curl <a href="https://get.docker.com/builds/Linux/x86_64/docker-latest.tgz">https://get.docker.com/builds/Linux/x86_64/docker-latest.tgz</a> | tar xvz -C /tmp/ &amp;&amp; mv /tmp/docker/docker /usr/bin/docker</div><div>user jenkins</div><div><br/></div><div>----- 会报下面这个错,看看是不是BUILD要加GROUP  </div><div><span style="font-size: 14pt; color: rgb(255, 0, 0);">-u root \ 启动参数加入解决下面报错</span></div><div>Got permission denied while trying to connect to the Docker daemon socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/containers/json: dial unix /var/run/docker.sock: connect: permission denied</div><div><br/></div><div><br/></div><hr/><div style="text-align: left;"></div><div> </div></div><div><span style="font-size: 18pt;">使用PORTAINER镜像管理本机节点</span></div><div><font style="font-size: 10pt;"><br/></font></div><div>docker pull portainer/agent:linux-arm64-1.6.0-alpine</div><div><br/></div><div>docker run -d -p 9000:9000 \</div><div>-v /var/run/docker.sock:/var/run/docker.sock \</div><div>-v /data/portainer_data:/data \</div><div>--name portainer \</div><div>docker.io/portainer/portainer:1.24.1-alpine</div><div><br/></div><hr/><div><br/></div><div><span style="font-size: 18pt;">搭建REDIS集群</span></div><div><span style="font-size: 18pt;"><br/></span></div><hr/><div><span style="color: rgb(255, 70, 53);">报错备注</span></div><div><br/></div><div>1.</div><div>ERROR</div><div>docker network create --driver overlay --scope=swarm --attachable redis-net</div><div><br/></div><div>redis-net 是使用命令 docker network create --driver overlay redis-net 创建的。这个是默认方式创建的网络，只能被swarm service使用。</div><div>当我们的链码安装到fabric网络上去时，是程序的调用api接口运行的容器，那这个容器是不属于swarm service，所以报这个错了。</div><div><br/></div><div>2.</div><div>通过断点可以看到，集群中的节点ip/端口是准确的，但是异常提示出来个无法连接127.0.0.1:7001，出现这个问题的原因，主要是我们在创建redis集群的时候，设置集群节点使用如下面的命令</div><div>redis/src/redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002</div><div>通过上面这种方式创建的redis集群，并没有什么问题，但是在springbot的整合中，通过redis集群获取到的节点信息就是127.0.0.1:7000... 然后导致上面的问题，因此一个解决办法是在创建集群的时候，指定下ip</div><div>首先数据和配置，然后重新建立集群关系</div><div>redis/src/redis-cli  --cluster create 192.168.0.203:7000 192.168.0.203:7001 192.168.0.203:7002</div><div><br/></div><div><br/></div><hr/><div>清理命令</div></div><div><br/></div><div>// 删除所有退出的容器</div><div><span style="font-size: 13px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(0, 0, 0); font-family: &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">docker rm ($docker ps -qf status=exited)</span></div><div><br/></div><div><span style="font-family: &quot;PingFang SC&quot;;">// 删除所有名为</span></div><div><span style="font-family: &quot;PingFang SC&quot;;">docker stop `docker ps -a| grep redis | awk '{print $1}'</span><span style="font-family: &quot;PingFang SC&quot;;">`</span></div><div><span style="font-family: &quot;PingFang SC&quot;;">docker rm `docker ps -a| grep </span><span style="font-family: &quot;PingFang SC&quot;;">redis</span> <span style="font-family: &quot;PingFang SC&quot;;">| awk '{print $1}' `</span></div><div><br/></div><div><div><span style="font-family: &quot;PingFang SC&quot;;">rm -f /data/redis700*/data/*</span></div><hr/><div>基础命令</div><div>docker swarm init</div><div>docker pull redis:5.0.9-alpine3.11</div><div><br/></div><div><br/></div><hr/><div>NETWORK BRIDGE模式</div><div><span style="text-decoration: line-through;">docker network create redis-net</span></div><div><span style="color: rgb(77, 206, 29);">docker network create --driver bridge --subnet 172.27.0.0/16 redis-net 这个建立网络才是正确的，同时能指定容器子网IP</span></div><div><br/></div><div>// REDIS集群配置</div><div>port 7001</div><div>cluster-enabled yes</div><div>cluster-config-file nodes.conf</div><div>cluster-node-timeout 5000</div><div>cluster-announce-ip 106.52.53.192</div><div>cluster-announce-port 7001</div><div>cluster-announce-bus-port 17001</div><div>appendonly yes</div><div><br/></div><div>// 启动脚本</div><div>for port in `seq 7001 7006`; do \</div><div>docker run -p ${port}:${port} -p 1${port}:1${port} \</div><div>-v /data/redis${port}/conf/redis${port}.conf:/redis/redis.conf \</div><div>-v /data/redis${port}/data:/data \</div><div>-v /home/software/redis-5.0.9:/redis \</div><div>--net redis-net \</div><div>--sysctl net.core.somaxconn=1024 \</div><div>--name redis${port} \</div><div>--ip 172.27.0.`expr ${port} - 6990` \</div><div>-d redis:5.0.9-alpine3.11 redis-server /redis/redis.conf; \</div><div>done</div><div><br/></div><div>// 外部调用生效</div><div>redis-cli --cluster create 172.27.0.11:7001 \</div><div>172.27.0.12:7002 \</div><div>172.27.0.13:7003 \</div><div>172.27.0.14:7004 \</div><div>172.27.0.15:7005 \</div><div>172.27.0.16:7006 \</div><div>--cluster-replicas 1</div><div><br/></div><div>// 腾讯云开放 7001-7006端口，17001-17006端口，否则拿外网IP创建集群失败</div><div><br/></div><div>redis-cli --cluster create 106.52.53.192:7001 106.52.53.192:7002 106.52.53.192:7003 106.52.53.192:7004 106.52.53.192:7005 106.52.53.192:7006 --cluster-replicas 1</div><div>redis-cli --cluster create 172.27.0.11:7001 172.27.0.12:7002 172.27.0.13:7003 172.27.0.14:7004 172.27.0.15:7005 172.27.0.16:7006 --cluster-replicas 1</div><div><br/></div><div>// 注意创建集群时也要是外网IP，配置文件cluster-announce-ip 106.52.53.192</div><div>redis:</div><div>  cluster:</div><div>    nodes: 106.52.53.192:7001,106.52.53.192:7002,106.52.53.192:7003,106.52.53.192:7004,106.52.53.192:7005,106.52.53.192:7006</div><div><br/></div><div><br/></div><hr/><div>NETWORK SWARM模式，至今不行。当NETWORK为OVERLAY时，SWARM模式下每次重启IP都会变，这样无法固定IP建立集群，<span style="color: rgb(255, 0, 0);">待以后研究</span></div><div><span style="text-decoration: line-through;">docker network create -d overlay redis-net //</span> <span style="color: rgb(255, 70, 53);">OVERLAY网络模式，容器IP无法固定分配，每次重启后IP都会变。所以要换成BRIDGE模式</span></div><div><span style="text-decoration: line-through;">docker network create --scope=swarm redis-net</span></div><div><span style="text-decoration: line-through;">docker network create --driver bridge --scope=swarm --subnet 172.22.0.0/16 redis-net </span></div><div><span style="text-decoration: line-through;">docker network create --driver overlay --scope=swarm --attachable redis-net</span></div><div><br/></div><div>docker stack deploy -c redis-cluster-stack.yml redis-cluster</div><div><br/></div><div>redis-cli --cluster create 172.27.0.11:7011 \</div><div>                                        172.27.0.12:7012 \</div><div>                                        172.27.0.13:7013 \</div><div>                                        172.27.0.14:7014 \</div><div>                                        172.27.0.15:7015 \</div><div>                                        172.27.0.16:7016  --cluster-replicas 1</div><div>                                    </div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 